<!doctype html><html lang=en-gb data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Rust async batching with benjamin-batchly - alexheretic posts</title><meta name=description content="Sometimes instead of doing lots of little things concurrently, it is better to bundle them together and do them all at once, as a batch. So on a bank holiday Thursday morning I awoke early (mostly due to the screams of my 1 year old boys) and (after the screaming stopped) wrote a crate to help do that: benjamin_batchly.
Example: Inserting into a database A recurring theme of database optimisation is reducing &ldquo;trips&rdquo; to the database."><link rel=icon type=image/x-icon href=https://alexheretic.github.io/favicon.ico><link rel=apple-touch-icon-precomposed href=https://alexheretic.github.io/favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><link rel=stylesheet href=https://alexheretic.github.io/css/style.min.c6a5c56d82abc1aa3a1925bf0b67884906e878e4e5bfb5af069b0a3e35e32569.css integrity="sha256-xqXFbYKrwao6GSW/C2eISQboeOTlv7WvBpsKPjXjJWk="><script src=https://alexheretic.github.io/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js type=text/javascript integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script><meta property="og:title" content="Rust async batching with benjamin-batchly"><meta property="og:description" content="Sometimes instead of doing lots of little things concurrently, it is better to bundle them together and do them all at once, as a batch. So on a bank holiday Thursday morning I awoke early (mostly due to the screams of my 1 year old boys) and (after the screaming stopped) wrote a crate to help do that: benjamin_batchly.
Example: Inserting into a database A recurring theme of database optimisation is reducing &ldquo;trips&rdquo; to the database."><meta property="og:type" content="article"><meta property="og:url" content="https://alexheretic.github.io/posts/benjamin-batchly/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rust async batching with benjamin-batchly"><meta name=twitter:description content="Sometimes instead of doing lots of little things concurrently, it is better to bundle them together and do them all at once, as a batch. So on a bank holiday Thursday morning I awoke early (mostly due to the screams of my 1 year old boys) and (after the screaming stopped) wrote a crate to help do that: benjamin_batchly.
Example: Inserting into a database A recurring theme of database optimisation is reducing &ldquo;trips&rdquo; to the database."></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=header-top><h1 class=site-title><a href=/>alexheretic posts</a></h1><ul class=social-icons><li><a href=https://github.com/alexheretic title=Github rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></li><li><a href=https://twitter.com/alexbigab title=Twitter rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span></a></li><li><a href=https://alexheretic.github.io/index.xml title=RSS rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></span></a></li></ul></div><nav></nav></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">Rust async batching with benjamin-batchly</h1></header></div><div class="content e-content"><p>Sometimes instead of doing lots of little things concurrently, it is better to bundle them together
and do them all at once, as a <em>batch</em>. So on a bank holiday Thursday morning I awoke early (mostly due to the screams of my 1 year old boys) and (after the screaming stopped) wrote a crate to help do that: <a href=https://github.com/alexheretic/benjamin-batchly>benjamin_batchly</a>.</p><h2 id=example-inserting-into-a-database>Example: Inserting into a database
<span><a href=#example-inserting-into-a-database><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>A recurring theme of database optimisation is reducing &ldquo;trips&rdquo; to the database. It is usually faster to send 1 fat message containing N items than it is to send N thin messages containing just 1 item.</p><p>Consider a crud-style create request which we&rsquo;d like to insert into a database.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle_create_foo</span>(db: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Db</span>, data: <span style=color:#a6e22e>CreateFooRequest</span>) -&gt; Result<span style=color:#f92672>&lt;</span>(), Error<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> db_item <span style=color:#f92672>=</span> DbItem::from(data);
</span></span><span style=display:flex><span>    db.insert(db_item).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So for each <em>CreateFooRequest</em> we will insert a single item into our db. We can batch these with a <em>BatchMutex</em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> benjamin_batchly::{BatchMutex, BatchResult};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle_create_foo</span>(
</span></span><span style=display:flex><span>    batch_mutex: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>BatchMutex</span><span style=color:#f92672>&lt;</span>(), DbItem<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    db: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Db</span>,
</span></span><span style=display:flex><span>    data: <span style=color:#a6e22e>CreateFooRequest</span>,
</span></span><span style=display:flex><span>) -&gt; Result<span style=color:#f92672>&lt;</span>(), Error<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> db_item <span style=color:#f92672>=</span> DbItem::from(data);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>match</span> batch_mutex.submit((), db_item).<span style=color:#66d9ef>await</span> {
</span></span><span style=display:flex><span>        BatchResult::Work(<span style=color:#66d9ef>mut</span> batch) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            db.bulk_insert(<span style=color:#f92672>&amp;</span>batch.items).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>            batch.notify_all_done();
</span></span><span style=display:flex><span>            Ok(())
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        BatchResult::Done(_) <span style=color:#f92672>=&gt;</span> Ok(()),
</span></span><span style=display:flex><span>        BatchResult::Failed <span style=color:#f92672>=&gt;</span> Err(Error::BatchFailed),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Submitting to the <em>BatchMutex</em> provides 3 async outcomes.</p><ul><li><em><strong>Work</strong></em> A batch of 1 or more items, including the one submitted, which should be handled.</li><li><em><strong>Done</strong></em> The submitted item was handled in a batch by another submitter & notified done.</li><li><em><strong>Failed</strong></em> The submitted item was handled in a batch by another submitter but dropped before notifying done.</li></ul><p>So if 100 <em>CreateFooRequest</em> requests come in while a batch is ongoing they&rsquo;ll await at <em>submit</em>. Once the previous batch has finished all waiting submissions become the next batch. 1 call will return <em>BatchResult::Work</em> and after the <em>batch.notify_all_done()</em> call 99 others will return <em>BatchResult::Done</em>.</p><p>Note: In the example I used the unit type () as the first argument for <em>submit</em>. This is the &ldquo;batch key&rdquo; which can be used to partition batching. Only items submitted with the same batch key are bundled together which is useful in more general cases.</p><p>Note(2): Individual item return values are also supported, check out the <a href=https://docs.rs/benjamin_batchly/latest/benjamin_batchly>docs</a> for more info.</p><h2 id=benjamin-batchly-implementation-goals>benjamin-batchly implementation goals
<span><a href=#benjamin-batchly-implementation-goals><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>Some I had goals for the implementation:</p><ul><li>Avoid spawning any additional tasks.</li><li>Avoid lifetime issues (so probably avoid async closures).</li></ul><p>By using a async return value instead of a closure it&rsquo;s clear who is doing the work here and avoids lifetime borrowing & move issues in the abstraction.</p><ul><li>All submissions <strong>must</strong> know whether the batch worked or not.</li><li>Usage should be as &ldquo;foolproof&rdquo; as possible.</li></ul><p>One of the wonderful Rust concepts that really allows this lib to shine is the <a href=https://doc.rust-lang.org/std/ops/trait.Drop.html>Drop trait</a>. It eliminates foot guns by reliably providing feedback to submit callers in the edge cases. Love it.</p><ul><li>Batching should have minimal latency overhead.</li></ul><p>In my motivating use case I&rsquo;m fine with batch sizes of 1 for low traffic and I didn&rsquo;t want to wait artificially. The currently implementation the batch size is totally driven by how long it takes to do the work and how many new submissions are incoming. So slow processes with high traffic will naturally see bigger batches. Submissions are never waiting around for a batch, if they can go, they go. Maybe in future the crate should also handing some form of configurable waiting, if there&rsquo;s a good use case?</p></div><div class=post-info><div class="post-date dt-published">2022-06-07</div><a class="post-hidden-url u-url" href=https://alexheretic.github.io/posts/benjamin-batchly/>https://alexheretic.github.io/posts/benjamin-batchly/</a>
<a href=https://alexheretic.github.io class="p-name p-author post-hidden-author h-card" rel=me>Alex Butler</a><div class=post-taxonomies></div></div></article><div class="pagination post-pagination"><div class="left pagination-item"><a href=/posts/ab-av1-2/>ab-av1: Letting other encoders in to the party</a></div><div class="right pagination-item"><a href=/posts/ab-av1/>AV1 encoding: ab-av1</a></div></div></main><footer class=common-footer><div class=common-footer-bottom><div class=copyright><p>Â© Alex Butler, 2022<br></p></div><button class=theme-switcher>
Dark theme</button>
<script>const STORAGE_KEY="user-color-scheme",defaultTheme="dark";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeButtonText()};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme=="dark"&&document.documentElement.setAttribute("data-theme","dark"),currentTheme=="auto"&&(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)),switchButton&&(changeButtonText(),switchButton.addEventListener("click",switchTheme,!1)),showContent()});function detectCurrentScheme(){return localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"light"}function changeButtonText(){switchButton&&(switchButton.textContent=currentTheme=="dark"?"Light theme":"Dark theme")}function switchTheme(){currentTheme=="dark"?(localStorage.setItem(STORAGE_KEY,"light"),document.documentElement.setAttribute("data-theme","light"),currentTheme="light"):(localStorage.setItem(STORAGE_KEY,"dark"),document.documentElement.setAttribute("data-theme","dark"),currentTheme="dark"),changeButtonText()}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}</script></div><p class="h-card vcard"><a href=https://alexheretic.github.io class="p-name u-url url fn" rel=me>Alex Butler</a>
<img class=u-photo src=/images/me.webp></p></footer></div></body></html>